<!DOCTYPE html>
 <html lang="en">
 <head>
	<meta charset="utf-8"/>
	<title>Date a Dog</title>

	<link rel="icon" href="sample.png">
	
	<link rel ="stylesheet" type="text/css" href="css/style.css" />
	<link rel ="stylesheet" type="text/css" href="css/content-display.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="js/fbinit.js"></script>
	<script src="js/fblogin.js"></script>
	<script src="js/address.js"></script>
	<script src="js/dogprofile.js"></script>
	<script src="js/daterprofile.js"></script>
	<script src="js/daterequest.js"></script>
	<script src="js/shelter.js"></script>
 </head>
<body id="dad">

  <script> 
    window.fbAsyncInit = function() {
      FB.init({
        appId: '1105437202885536',
        cookie: true, // This is important, it's not enabled by default
        version: 'v2.2'
      });
    
      FB.getLoginStatus(function (response) {
        if (response.status === 'connected') {
      	console.log("Logged in as" + response.authResponse.accessToken);
        loadData(response);
        
        } else {
          // log in again code
          console.log("Expired token");
          logout();
        }

     });
   };

     (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="index.html">Date A Dog</a>
			</div>
			
			<ul class="nav navbar-nav navbar-right">
				<li><a href="https://date-a-dog.github.io/">Help</a></li>
				<li><a href="requests.html">Requests</a></li>
				<li><a href="history.html">History</a></li>
				<li><a href="index.html" onclick="logout()">Logout</a></li>
			</ul>
		</div>
	</nav>
	
	<h1>History</h1>

	<!-- For placement of request history -->
	<div id="accordion">
		<!-- Message for empty history page -->
		<div class="accordionTitle" id="noRequests">
			<h3>You have no request history.</h3>
		</div>
	</div>
	<!-- Fills accordion with history display -->
	<script type="text/javascript">

		jQuery(function() { 
		  jQuery( "#accordion" ).accordion({
                    collapsible: true,  // enable collapse all
                    active: false // collapsed by default   
                  });
		});
		var siteUrl = '/'; 
          function logout() {
            FB.logout();
            window.location.href = "http://ec2-35-160-226-75.us-west-2.compute.amazonaws.com/index.html"; 
          };
          var shelter;         
          function loadData(fbResponse) {
		shelter = Shelter(fbResponse.authResponse.accessToken);
		shelter.updateDateRequests(function(){ 

			var requestsList = shelter.getHistoryRequests();
			//removes the empty history page info if there is history
			if(requestsList.length > 0){
				$("#accordion").empty(); //remove child nodes
			}
			
			for (var i = 0; i < requestsList.length; i++) {
				var r = requestsList[i];
                                var imgName = (r.status == "A") ? "check_icon.png": "x_icon.png";
                                var newDiv = "<div class=\"accordionTitle\"><img src=" + imgName +" width=\"30\" height=\"38\"><h3> Dog Name: " + r.dogProfile.name + "</h3>"+
                                                        "<h3>Dater: " + r.daterProfile.fName +" " + r.daterProfile.lName + "</h3>"+
                                                        "<h3>When: "+ r.dateTime + "</h3>"+
                                                        "</div> " + 
                                                        "<div class=\"accordionEle\"> " + 
                                                        "<p>" +
                                                        "<h3> Requester Details </h3><br>" + 
                                                        "Name:  <strong>"  + r.daterProfile.fName +" " + r.daterProfile.lName +"</strong><br>" +
                                                        "Phone: <strong>" + r.daterProfile.phone + "</strong><br>" +
                                                        "Email: <strong>" + r.daterProfile.email + "</strong><br>" +
                                                        "Street: <strong>" + r.daterProfile.address.street + "</strong><br>" +
                                                        "City: <strong>" + r.daterProfile.address.city + "</strong><br>" +
                                                        "State: <strong>" + r.daterProfile.address.state + "</strong><br>" + 
                                                        "Zipcode: <strong>"+r.daterProfile.address.zipcode+"</strong>"+ 
                                                        "</p>" + 
                                                        "<h3>Date requested with: </h3><br>" +
                                                        "<p><img class=\"accordion-img\" src=\""+ r.dogProfile.photoURL +"\" alt=\"dog image\">  " + 
                                                        "<strong>"+r.dogProfile.name+"</strong> </p>" +
                                                        "Age: <strong>" + r.dogProfile.age + "</strong><br>" +
                                                        "Sex: <strong>" + r.dogProfile.sex + "</strong><br>" +
                                                        "Dog Id: <strong>" + r.dogProfile.id + "</strong><br>" + 
							"<p class=\"request-button-container\"> " + 
				                        "<button id =\"U" + r.id + "\" class=\"request-buttons btn btn-secondary btn-lg\" onclick=\"undoRequest(" + r.id + ")\"> Undo</button> " + 
							 "</p>" +
							 "</div>"; 
				$("#accordion").append(newDiv);
			}
			$("#accordion").accordion("refresh");
			$("#accordion").accordion();

			jQuery( document ).ready(function() {
				//alert( "document loaded" );
			});
 
		});

           };  // end of loadData()

        function undoRequest(reqId){  
          var undoButton = document.getElementById("U" + reqId);
          undoButton.disabled = true;
          shelter.updateRequestStatus(reqId, "P");
          alert("Undoing request: " + reqId);
        };
	</script>
	
 </body>
